<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>PluckNode</title>
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
  <link rel="stylesheet" href=//cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.css>
  <style>
      #code { padding: 0; margin: 0; background: white; border: none }
      #app { margin: 10px 0 }
      #app .btn { width: 100px }
    </style>
</head>
<body>
  <div class="container">
    <div class="page-header">
      <h1>pluck-node</h1>
      <div>
        <a href="https://travis-ci.org/mohayonao/pluck-node"><img src="http://img.shields.io/travis/mohayonao/pluck-node.svg?style=flat-square"/></a>
        <a href="https://www.npmjs.org/package/pluck-node"><img src="http://img.shields.io/npm/v/pluck-node.svg?style=flat-square"/></a>
        <a href="http://mohayonao.mit-license.org/"><img src="http://img.shields.io/badge/license-MIT-brightgreen.svg?style=flat-square"/></a>
      </div>
    </div>
    <div>Pluck String AudioNode for Web Audio API | <a href="https://github.com/mohayonao/pluck-node" target="github">GitHub</a></div>
    <div id="app">
      <button id="button" class="btn btn-default">Start</button>
      </div>
      <div class="panel panel-default">
        <div class="panel-heading">
          <h3 class="panel-title">example</h3>
        </div>
        <div class="panel-body">
          <pre class="prettyprint" id="code"></pre>
        </div>
      </div>
    </div>
  </div>
  <script src="//cdnjs.cloudflare.com/ajax/libs/prettify/r298/prettify.min.js"></script>
  <script src="//mohayonao.github.io/web-audio-scheduler/build/web-audio-scheduler.min.js"></script>
  <script src="build/pluck-node.js"></script>
  <script>
  window.AudioContext = window.AudioContext || window.webkitAudioContext;

  window.addEventListener("DOMContentLoaded", function() {
    "use strict";

    var isPlaying = false;

    document.getElementById("button").addEventListener("click", function(e) {
      isPlaying = !isPlaying;

      if (isPlaying) {
        sched.start(compose);
        e.target.textContent = "Stop";
      } else {
        sched.stop(true);
        e.target.textContent = "Start";
      }
    });

    // code
    document.getElementById("code").textContent = document.getElementById("example").textContent;

    prettyPrint();
  });
  </script>
  <script id="example">
    var audioContext = new AudioContext();
    var sched = new WebAudioScheduler({ context: audioContext });

    function chord(e) {
      var playbackTime = e.playbackTime;
      var notes = e.args.notes;

      notes.forEach(function(note, i) {
        var t0 = playbackTime + i * 0.025;
        var t1 = t0 + 2;
        var pluck = new PluckNode(audioContext, 400, 20);
        var gain = audioContext.createGain();
        var freq = 220 * Math.pow(2, note / 12);

        pluck.frequency.setValueAtTime(freq, t0);
        pluck.frequency.exponentialRampToValueAtTime(freq * 1.01, t1);

        pluck.start(t0);
        pluck.stop(t1);
        pluck.connect(gain);

        gain.gain.setValueAtTime(0.8, t0);
        gain.gain.linearRampToValueAtTime(0.0, t1);
        gain.connect(audioContext.destination);
      });
    }

    function compose(e) {
      var t0 = e.playbackTime;
      var notes = sample([
        [ 0, 4, 9, 11 ],
        [ 0, 2, 7, 11 ],
        [ 0, 2, 5, 11 ],
      ]);

      sched.insert(t0, chord, { notes: notes });
      sched.insert(t0 + 1, compose);
    }

    function sample(list) {
      return list[(Math.random() * list.length)|0];
    }
  </script>
</body>
</html>
